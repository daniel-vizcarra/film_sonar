<%# app/views/movies/index.html.erb %>
<h1>Catálogo de Películas</h1>

<%# --- Contenedor Principal para el Controlador Stimulus 'sidebar' --- %>
<div data-controller="sidebar">

  <%# --- Controles Principales: Botón de Filtro y Formulario de Ordenamiento --- %>
  <div class="catalog-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 10px 0; border-bottom: 1px solid #eee;">
    <div>
      <button type="button" class="button" data-action="click->sidebar#open">
        FILTRAR
      </button>
    </div>
    <div class="sort-controls">
      <%= form_with(url: movies_path, method: :get, local: true, data: { turbo_frame: "_top" }) do |form| %>
        <%# Mantener filtros de género activos al ordenar %>
        <% if params[:genre_ids].present? %>
          <% Array(params[:genre_ids]).reject(&:blank?).each do |genre_id| %>
            <%= hidden_field_tag "genre_ids[]", genre_id %>
          <% end %>
        <% end %>

        <%# Mantener filtros de director activos al ordenar %>
        <% if params[:director_ids].present? %>
          <% Array(params[:director_ids]).reject(&:blank?).each do |director_id| %>
            <%= hidden_field_tag "director_ids[]", director_id %>
          <% end %>
        <% end %>

        <%= form.label :sort_by, "Ordenar por:", style: "margin-right: 8px; font-weight: normal;" %>
        <%= form.select :sort_by,
                        options_for_select([
                          ["Año (Más Recientes)", "release_year_desc"],
                          ["Año (Más Antiguos)", "release_year_asc"],
                          ["Título (A-Z)", "title_asc"],
                          ["Título (Z-A)", "title_desc"],
                          ["Director (A-Z)", "director_asc"],
                          ["Director (Z-A)", "director_desc"],
                          ["Mejor Puntaje FilmSonar", "score_desc"], 
                          ["Peor Puntaje FilmSonar", "score_asc"]   
                        ], params[:sort_by] || "release_year_desc"),
                        {},
                        { onchange: "this.form.submit();", class: "sort-select" } %>
      <% end %>
    </div>
  </div>

  <%# --- Panel Lateral para Filtros (Sidebar) --- %>
  <div id="filter-sidebar" class="filter-sidebar" data-sidebar-target="panel">
    <%# El formulario de filtros ahora envuelve el contenido del sidebar %>
    <%= form_with(url: movies_path, method: :get, local: true, data: { turbo_frame: "_top" }) do |form| %>
      <div class="filter-sidebar-header">
        <h3>Filtros</h3>
        <button type="button" class="close-sidebar-button" data-action="click->sidebar#close">&times;</button>
      </div>

      <div class="filter-sidebar-content">
        <%# Filtros por Género %>
        <div class="filter-section">
          <h4>Géneros</h4>
          <div class="filter-options-grid genres-grid">
            <% @genres.each do |genre| %>
              <div class="filter-option">
                <%= check_box_tag "genre_ids[]", genre.id, Array(params[:genre_ids]).include?(genre.id.to_s), id: "genre_#{genre.id}" %>
                <%= label_tag "genre_#{genre.id}", genre.name %>
              </div>
            <% end %>
          </div>
        </div>

        <%# Filtros por Director %>
        <div class="filter-section" style="margin-top: 20px;">
          <h4>Directores</h4>
          <% if @directors.any? %>
            <div class="filter-options-grid directors-grid">
              <% @directors.each do |director| %>
                <div class="filter-option">
                  <%= check_box_tag "director_ids[]", director.id, Array(params[:director_ids]).include?(director.id.to_s), id: "director_#{director.id}" %>
                  <%= label_tag "director_#{director.id}", director.name %>
                </div>
              <% end %>
            </div>
          <% else %>
            <p>No hay directores para filtrar.</p>
          <% end %>
        </div>
      </div>

      <div class="filter-sidebar-actions">
        <%# El botón Resetear es un link que quita los filtros pero mantiene el ordenamiento actual %>
        <%# También debe incluir los parámetros de ordenamiento actual si existen %>
        <%= link_to "Resetear", movies_path(sort_by: params[:sort_by]), class: "button-secondary", data: { action: "click->sidebar#close" } %>
        
        <%# El botón Aplicar envía el formulario y luego cierra el sidebar (la acción de cerrar se puede manejar en el JS del form submit si es necesario o dejarla así) %>
        <%= form.submit "Aplicar Filtros", class: "button", style: "margin-left: 10px;", data: { action: "click->sidebar#close" } %>
      </div>
    <% end %> <%# Fin del form_with del sidebar %>
  </div>

  <%# --- Overlay para el fondo del Sidebar --- %>
  <div id="sidebar-overlay" class="sidebar-overlay" data-sidebar-target="overlay" data-action="click->sidebar#close"></div>

</div> <%# --- Fin del Contenedor Principal data-controller="sidebar" --- %>


<%# --- Mensaje de Filtros Activos --- %>
<% if @active_filters_message.present? %>
  <p style="margin-top: 10px; font-style: italic;">Mostrando películas para: <strong><%= @active_filters_message %></strong></p>
<% end %>


<%# --- Lista de Películas --- %>
<div class="movie-list">
  <% if @movies.any? %>
    <% @movies.each do |movie| %>
      <div class="movie-card">
        <%= link_to movie_path(movie) do %>
          <% if movie.poster_url.present? %>
            <%= image_tag movie.poster_url, alt: movie.title, class: "movie-poster-thumbnail" %>
          <% else %>
            <div class="movie-poster-thumbnail"></div> <%# Placeholder si no hay imagen %>
          <% end %>
          <h2><%= movie.title %> <span style="font-weight: normal; color: #6c757d;">(<%= movie.release_year %>)</span></h2>
        <% end %>

        <% if movie.director&.name.present? %>
          <p class="movie-card-director"><strong>Dir:</strong> <%= movie.director.name %></p>
        <% end %>

        <%# Mostrar Puntaje Ponderado en la tarjeta %>
        <% if movie.weighted_score.present? %>
          <p class="movie-card-score">
            <strong>Puntaje:</strong> <%= "%.1f" % movie.weighted_score %>/100
          </p>
        <% end %>
      </div>
    <% end %>
  <% else %>
    <p>No hay películas en el catálogo que coincidan con tus filtros.</p>
  <% end %>
</div>

<%# --- Navegación de Paginación --- %>
<div class="pagy-nav-container" style="text-align: center; margin-top: 20px;">
  <%== pagy_nav(@pagy) if @pagy.present? && @pagy.pages > 1 %>
</div>